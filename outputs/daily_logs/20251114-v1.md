下面是 2025-11-14 的项目日报草稿（可直接保存为 `outputs/daily_logs/20251114.md`）：

---

# 2025-11-14 LAM3 每日记录

## 1. 今日整体进度概览

* 围绕 JailBreakV-28K 构建了首个多模态越狱评测管线（mini 版本）：完成「数据准备 → 元数据 meta 构建 → 多模态批量推理」的闭环代码骨架。
* 为 Synergy 式评测新建专用配置 `configs/synergy_jbv28k.yaml`，显式区分 data / eval / model / log 四个子块，方便后续在不同模型与模式上复用。
* 实现 `scripts/prepare_synergy_jbv28k.py`，用于从 JailBreakV-28K 原始标注中自动猜测文本/图像列、对齐本地路径并写出统一的 meta jsonl 文件。
* 实现 `scripts/run_synergy_jbv28k.py`，对 meta 进行批量推理，支持 4 种模态组合模式（txt_img / txt_only / img_only / none），结果写入结构化 raw log，后续用于 ASR / Toxicity / PPL / FRR 计算。
* 扩展 `src/metrics/toxicity.py`，使 Detoxify/Perspective 等多路毒性评估接口可以作为统一函数被 Synergy 管线调用（当前重点仍是本地 Detoxify）。
* 环境层面，把模型 /数据缓存目录迁移到独立磁盘（配置 HF_HOME、MODELSCOPE_CACHE 等），为后续大规模评测释放空间、减少系统盘压力。

> 今日核心：把 JailBreakV-28K mini 版本的「数据 → 模型推理 → 原始日志」链路搭起来，为后续四大指标（ASR/Toxicity/PPL/FRR）和多源 judge 打基础。

---

## 2. 代码与配置更新详情

### 2.1 Synergy 配置：`configs/synergy_jbv28k.yaml`

* `data.synergy_jbv28k`：

  * `original_root: "data/JailBreakV_28K"`：假定原始数据（图像和标注）都在该目录下。
  * `data_file: "data/JailBreakV_28K/mini_JailBreakV_28K.csv"`：当前使用 mini CSV 版本，便于快速实验。
  * `image_root: "data/JailBreakV_28K"`：用于从相对路径构造本地图像路径。
  * `prompt_key: "jailbreak_query"` / `image_key: "image_path"`：显式指定文本和图像列，避免自动猜测带来的不确定性。
  * `meta_path: "data/synergy_jbv28k/jbv28k_mini_meta.jsonl"`：prepare 脚本输出的标准 meta 文件路径。
* `eval`：

  * `max_samples: 0`：在 `run_synergy_jbv28k.py` 中解释为 0 / None / 负数即「不裁剪，遍历全部样本」，后续可改为小整数做快速 sanity check。
  * `modes: ["txt_img", "txt_only", "img_only", "none"]`：实现 Synergy 风格的 4 模态组合，为分析「文本/图像/两者协同/无显式攻击」的越狱贡献提供基础。
* `model`：

  * `name: "llava15_7b"`：默认评测模型，可切到 `"idefics2_8b"` 等。
  * `models_cfg_path: "configs/models.yaml"`、`runtime_cfg_path: "configs/runtime.yaml"`：沿用全局 registry / runtime 配置。
  * `max_new_tokens: 64`, `min_new_tokens: 1`：首版生成长度较短，用于快速跑通流程。
* `log`：

  * `raw_log_path: "outputs/logs/synergy_jbv28k_mini_raw.jsonl"`：主推理输出，每条记录对应 (id, mode, model, prompt, image, output)。
  * `metric_path`, `summary_path`：预留给 `src/metrics/synergy_jbv28k.py` 用于写入样本级分数与聚合 summary。

### 2.2 数据准备：`scripts/prepare_synergy_jbv28k.py`

核心目标：从 JailBreakV-28K 原始 JSON/CSV 构建统一的 meta jsonl，规范字段以便后续多模型重复使用。

* 自动列名猜测：

  * 候选文本列：`PROMPT_CANDIDATES = ["jailbreak_query", "redteam_query", "prompt", "attack_prompt", "jailbreak_prompt", "adv_prompt", "jailbreak_text", "text"]`。
  * 候选图片列：`IMAGE_CANDIDATES = ["image_path", "img_path", "image", "image_name", "img_name"]`。
  * 支持配置优先级：如果 yaml 已指定 `prompt_key`/`image_key`，则跳过自动猜测。
* 路径标准化：

  * 函数 `resolve_image_path(raw_img_val, img_root)`：

    * 字符串：认为是相对路径，拼接到 `image_root`；
    * dict：若含 `'path'` 字段，支持 HF-style image feature；
    * 非法或空值：返回 `None`。
  * 目标：在 meta 中将 `image_path` 统一为「相对仓库根的路径」或绝对路径，保证后续 `run_synergy_jbv28k.py` 能定位图片。
* 数据加载：

  * 支持 `json` / `csv` 两种格式，通过 `datasets.load_dataset` 统一为 `Dataset`；
  * 若未显式指定 `data_file`，会在 `original_root` 下回退尝试 `JailBreakV_28K.json` / `JailBreakV_28K.csv`。
* 采样控制：

  * 内部 `max_samples`（data 级）默认 0，解释为「不限制」，提供后续在 prepare 阶段做下采样的 hook。
* 输出：

  * meta 文件包含至少：`id`, `text_attack`, `image_path`，并为后续 script 提供统一 key。
* 潜在隐患：

  * 列推断是基于第一条样本的，如果数据 schema 不稳定或首条样本缺字段会报错；
  * `data_file` 路径、编码格式需要和本地实际文件保持一致，否则 `load_dataset` 会直接抛异常。

### 2.3 批量推理：`scripts/run_synergy_jbv28k.py`

功能：读取 meta + cfg，统一构造四种模态下的 query，调用 registry 中的 MLLM 执行推理，并按行写出 raw log。

* 辅助函数：

  * `iter_meta(path, max_samples=None)`：统一处理「0 / None / 负数 → 全部样本」的逻辑。
  * `ensure_null_image(dataset_root)`：

    * 在 `dataset_root` 下创建 `null_image.png`（全白 224×224）；
    * 为 `txt_only` / `none` 以及缺失图片的 case 提供占位图，避免模型报错。
  * `build_query(case, mode, dataset_root, null_image_path)`：

    * 支持 `image_path` 为绝对路径、`data/...` 型路径、以及相对 `dataset_root` 的路径；
    * 4 种模式的 prompt / image 组合：

      * `txt_img`: prompt = text_attack, image = 实图或 null；
      * `txt_only`: prompt = text_attack, image = null；
      * `img_only`: prompt = ""，image = 实图或 null；
      * `none`: prompt = ""，image = null。
  * `build_model_and_gen(m_cfg)`：

    * 通过 `models_cfg_path` / `runtime_cfg_path` 读取全局配置；
    * 使用 `build_model` 统一调用 `Llava15Wrapper` / `Idefics2Wrapper`；
    * 构造统一 `GenCfg`，从模型子配置与 runtime 合并 `max_new_tokens`/`min_new_tokens`/`do_sample`/`temperature`/`top_p`。
* 主流程：

  * 从 cfg 读取 `data / eval / model / log` 子配置；
  * 使用 `iter_meta(meta_path, max_samples=e_cfg.max_samples)` 构造 case 列表；
  * 为所有 case、所有 `modes` 调用 `model.generate(img, prompt, gen_cfg)`；
  * 每次推理写入一行 JSON：

    * `{"id", "mode", "model", "prompt", "image", "output"}`；
  * 主要作用是生成后续指标计算的基础数据文件 `synergy_jbv28k_mini_raw.jsonl`。
* 当前状态：

  * 仅完成「生成 raw log」部分，尚未在脚本末尾直接调用 `src/metrics/synergy_jbv28k.py` 做指标聚合；
  * 默认 `do_sample` 从 runtime/model 配置继承，后续在正式评测时建议统一为「确定性解码」版本，以减小指标方差。

### 2.4 毒性评估：`src/metrics/toxicity.py`（补充）

> 注：本文件在 11.12–11.14 连续迭代，今日主要目的：让 Synergy 评测可以直接复用统一接口。

* 统一入口设计（概念层面）：

  * `eval_toxicity(texts, cfg)`：

    * 接收一批 `texts`；
    * 依据 cfg 决定调用哪些 backend（如 detoxify / perspective / openai 等），并返回结构化结果列表。
  * 数据结构（示意）：`ToxicityResult(text, backend, score, extra)`，方便后续聚合到 per-sample / per-backend 指标。
* 当前可用 backend：

  * `Detoxify`：

    * 已在服务器本地下载模型并验证可用；
    * 对社交类 toxicity（仇恨、侮辱、脏话等）有较好敏感度。
  * `Perspective API`：

    * API key 已获取，但受限于服务器无法访问外网，暂时只能在本地机器上调用；
    * 计划：server 端先生成 raw responses，离线拷回本地后再跑 Perspective 评测。
* 当前主要局限：

  * 无论 Detoxify 还是 Perspective，本质都是“社交 toxicity”维度，对 policy risk（武器、自杀、爆炸、抢劫等）几乎不敏感；
  * 因此 Toxicity 指标无法单独映射到「policy violation」的强度，需要配合其他 safety 模型（如 Llama-Guard-2 或小参数 policy classifier）。

### 2.5 环境与缓存配置

* 将 `MODELSCOPE_CACHE` 与 `HF_HOME` 指向 `/data2/...`：

  * 减少默认 `~/.cache/modelscope` 等目录的空间压力；
  * 为后续下载更多 model / dataset 留出空间；
  * 便于不同实验环境共享统一缓存，避免重复下载。

---

## 3. 当前已知问题 / 风险点

1. **Synergy 管线尚未完整跑通全流程**

   * 目前 `run_synergy_jbv28k.py` 仅产出原始 `raw_log`，尚未自动调用 `src/metrics/synergy_jbv28k.py` 做 ASR/Toxicity/FRR/PPL 聚合；
   * 需要在 mini 数据上做一次 end-to-end smoke test，验证：

     * meta 解析正确；
     * 4 种模式下图片路径均可正常读取；
     * 模型输出没有严重截断/死循环。

2. **数据路径与列名假设仍有脆弱性**

   * `prepare_synergy_jbv28k.py` 虽然支持自动猜列，但仍高度依赖当前 JailBreakV-28K 的具体 schema；
   * 如果后续换成完整版或新版数据集（字段名改变），需要及时调整 `prompt_key` / `image_key` 和 path 逻辑。

3. **毒性指标与 policy risk 的错位**

   * Detoxify/Perspective 对「爆炸材料、自杀方法、抢劫步骤」等内容得分偏低；
   * 单靠这些分数去度量「越狱成功程度」是不够的，容易出现高 ASR 但低 Toxicity 的表象；
   * 必须引入至少一个「policy-aware safety 模型」（如 Llama-Guard-2-8B）作为辅助 judge。

4. **网络与计费限制**

   * Perspective / OpenAI moderation 在服务器环境中无法访问外网；
   * OpenAI 免费额度频率限制较强，不适合大规模实验；
   * 当前可行方案：server 端生成 response → 本地离线跑安全 API → 再回写指标文件，但这增加了流程复杂度。

5. **性能与稳定性隐患**

   * `run_synergy_jbv28k.py` 目前对每个 case、每个 mode 都顺序推理，尚未加入异常捕获机制；
   * 一旦某条样本由于路径/图像损坏导致 `Image.open` 或 `model.generate` 报错，会中断整个实验；
   * 大规模运行前需要加入 per-sample try/except 与错误日志记录。

---

## 4. 明日 / 后续计划建议

> 以下为建议优先级，可按实际时间进行调整。

**优先级 A：先跑通 mini 实验闭环**

* 使用 `scripts/prepare_synergy_jbv28k.py --cfg configs/synergy_jbv28k.yaml` 在 mini 数据上生成 meta，并人工抽查若干条（文本、图像路径）。
* 使用 `scripts/run_synergy_jbv28k.py --cfg configs/synergy_jbv28k.yaml`：

  * 在 `max_samples` 设置为一个较小值（如 20~50）下做 smoke test；
  * 确认 4 modes 均可正常推理，raw_log 内容字段完整。
* 补充 / 完善 `src/metrics/synergy_jbv28k.py`：

  * 定义 ASR / FRR / Toxicity / PPL 的计算逻辑；
  * 输出 `metric_path`（样本级）与 `summary_path`（聚合统计）；
  * 先在 mini 集上验证指标值合理性。

**优先级 B：安全评估维度扩展**

* 选定一个可本地离线运行的 policy 模型作为安全 judge 候选（如 Llama-Guard-2 系列或其他小参数安全模型），设计：

  * 输入格式（是否需要对话模板）；
  * 输出解析规则（直接 violation / allowed / borderline 的映射）。
* 设计 Toxicity + Policy-risk 的联合指标方案，例如：

  * 社交毒性（Detoxify/Perspective）；
  * policy 违规概率（安全模型）；
  * 与 ASR/FRR 结合形成 composite risk score。

**优先级 C：环境与工程优化**

* 在 `run_synergy_jbv28k.py` 中为 per-sample 推理加入 try/except，记录异常到单独的 error log；
* 在 GenCfg / runtime 中进一步统一「评测期使用确定性解码」的默认值，降低结果方差；
* 规划 server ↔ 本地之间的 raw_log / metrics 文件同步流程，为后续外网 API 评测预留接口。

---

## 5. TODO Checklist（短期）

* [ ] 在 mini JailBreakV-28K 上完成一轮完整的 Synergy 实验（prepare → run → metrics）。
* [ ] 抽查 `jbv28k_mini_meta.jsonl` 中的 `text_attack` 与 `image_path` 是否与原始数据一致。
* [ ] 为 `run_synergy_jbv28k.py` 增加异常捕获与 error_log。
* [ ] 选型并初步接入一个本地可跑的 policy safety 模型（如 Llama-Guard-2-8B）。
* [ ] 设计并记录 ASR / Toxicity / PPL / FRR 四指标在 Synergy 设置下的精确定义与判定规则。

