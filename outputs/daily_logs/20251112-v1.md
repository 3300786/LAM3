# 2025-11-12 LAM3 Daily Experiment Log

## 1. Overview

* Responsible: JsW
* Model(s): LLaVA-1.5-7B, IDEFICS2-8B
* Attack Type: 暂无（加载与冒烟验证为主）
* Dataset: `data/mini_bench`
* Goal of the day: 合并配置键位、收敛 wrapper 行为、降低 OOM 风险；清理历史隐患

---

## 2. Parameters & Settings

| Category  | Key                  | Value                        | Notes                          |
|-----------|----------------------|------------------------------|--------------------------------|
| Precision | precision            | bf16                         | 仅非量化生效                         |
| Device    | device_map           | auto                         | 与 `device` 二选一                 |
| Gen       | max_new_tokens       | 256                          | 统一上限                           |
| Gen       | min_new_tokens       | 64                           | 目前未在 wrapper 中使用               |
| Gen       | do_sample            | true                         | LLaVA 内部强制改为 `False`（见 Issues） |
| Gen       | temperature          | 0.2                          | 采样关闭时不生效                       |
| Gen       | top_p                | 0.95                         | 采样关闭时不生效                       |
| Seed      | seed                 | 42                           | 全局设定                           |
| Quant     | quantization.enabled | true                         | 统一替代旧键                         |
| Quant     | compute_dtype        | bf16                         |                                |
| Quant     | quant_type           | nf4                          |                                |
| Quant     | use_double_quant     | true                         |                                |
| Models    | llava15_7b.repo_id   | `/data2/.../llava-1.5-7b-hf` | 本地                             |
| Models    | idefics2_8b.repo_id  | `HuggingFaceM4/idefics2-8b`  | 远端                             |
| Processor | Idefics2Processor    | 默认                           | 已改为官方推荐                        |

---

## 3. Observations / Results

* 统一了量化配置入口：`quantization.enabled` 等键位已生效；旧键将由 `normalize_runtime` 兼容。
* `GenCfg` 现位于 `src/utils/runtime.py`，两模型 wrapper 已引用该单一定义（去重完成）。
* IDEFICS2：移除全局 patch 与默认设备改写；采用 BitsAndBytes 4bit，`device_map=None` 加载；启用 SDPA；短边控制保留。
* LLaVA：加入系统提示抑制幻觉，生成阶段**强制确定性解码**，输出清理更加稳健（eos/eot 多停码、轮次截断、两段限制）。

---

## 4. Issues & Bug Tracking

| ID           | Description                                                         | Severity | Status                 | Note                                                                                             |
|--------------|---------------------------------------------------------------------|----------|------------------------|--------------------------------------------------------------------------------------------------|
| B20251112-1  | 配置键不一致：旧 `load_in_4bit` vs 新 `quantization.enabled`                 | High     | **Resolved**           | 通过 `normalize_runtime` 兼容与统一                                                                     |
| B20251112-2  | 全局禁用 `accelerate.dispatch_model` 的副作用                               | High     | **Resolved**           | 已移除；改为常规加载                                                                                       |
| B20251112-3  | 全局 `set_default_device` 带来的隐性副作用                                    | High     | **Resolved**           | 已移除                                                                                              |
| B20251112-4  | `GenCfg` 多处重复定义                                                     | Medium   | **Resolved**           | 统一到 `src/utils/runtime.py`                                                                       |
| B20251112-5  | `registry.py` 忽略 `models.yaml.revision`                             | Medium   | Open                   | 加入 `revision=` 透传并落盘到日志                                                                          |
| B20251112-6  | LLaVA 未对齐 runtime 解码策略与精度/量化                                        | Medium   | **Partially Resolved** | 现强制 `do_sample=False`，与 `runtime.do_sample=True` 不一致；仍未读 `precision/quantization/attention_impl` |
| B20251112-7  | IDEFICS2 重复装饰器                                                      | Low      | **Resolved**           | 已移除                                                                                              |
| B20251112-8  | IDEFICS2 processor 未设 `local_files_only`（离线易失败）                     | Medium   | Open                   | 需按运行环境决定是否开启                                                                                     |
| B20251112-9  | `device_kwargs()` 未被 wrapper 使用                                     | Low      | Open                   | 决策：要么接入，要么清理                                                                                     |
| B20251112-10 | `prepare_env.sh` 未固定依赖版本                                            | Medium   | Open                   | 建议锁定区间并保存 `pip freeze`                                                                           |
| B20251112-11 | LLaVA 未使用 `min_new_tokens`；IDEFICS2 亦未使用                            | Low      | Open                   | 若需下界约束，请显式加入 `min_new_tokens`                                                                    |
| B20251112-12 | IDEFICS2 量化时 `device_map=None` 的设备放置依赖 HF/accelerate 版本             | Medium   | Open                   | 建议显式 `device_map="auto"` 或 `{"": "cuda:0"}` 以去除不确定性                                              |
| B20251112-13 | `scripts/smoke_test_models.py` 仍从 `src.models.idefics2` 导入 `GenCfg` | High     | **Resolved**           | 应改为 `from src.utils.runtime import GenCfg`，否则导入错误                                                |
| B20251112-14 | LLaVA 强制确定性解码导致温度/Top-p 不可控                                         | Medium   | **New**                | 可改为读取 `gen.do_sample`，测试期再统一覆盖                                                                   |
| B20251112-15 | 未将 `configs/runtime.yaml` 规范化入口（`normalize_runtime`）用于 wrapper 或脚本  | Medium   | **New**                | 建议在 `smoke_test_models.py` 读取后先规范化再传递                                                            |

---

## 5. Next Actions

* 修正 `smoke_test_models.py` 的 `GenCfg` 导入路径；在读取 runtime 后调用 `normalize_runtime()` 并落盘关键字段到日志。
* 在 `registry.build_model()` 透传 `revision` 并在 wrapper 内部调用 `from_pretrained(..., revision=...)`；同时把实际 `revision` 记入 `outputs/logs/smoke_test.jsonl`。
* LLaVA 生成策略：读取 `gen.do_sample` 决定是否确定性；将“评测期强制确定性”的策略放到调用侧或通过显式开关控制。
* 设备放置确定性：IDEFICS2 的量化分支改为 `device_map="auto"` 或 `{"": self._device}`，以避免版本差异带来的 CPU 落点。
* 视运行场景决定是否在两处理器上统一 `local_files_only`；并在 README 说明离线缓存准备方式。
* 评估是否需要 `min_new_tokens` 以避免过早终止；若需要则两 wrapper 一致支持。
* 定义依赖锁定策略：在 `prepare_env.sh` 输出 `pip freeze > outputs/env/pip_freeze_YYYYMMDD.txt` 并在日报记录快照路径。

---

## 6. Commit & Sync

* Git Commit: `TBD`
* Log Upload: 待更新（本次为规划与审阅）
* Timestamp: `2025-11-12 JST`
