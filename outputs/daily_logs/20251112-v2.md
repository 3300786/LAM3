# 2025-11-12 LAM3 每日实验日志

## 1. 概览

* 负责人：JsW
* 模型：LLaVA-1.5-7B、IDEFICS2-8B
* 当前阶段：基础加载与推理验证、毒性评测模块初步接入
* 数据集：`data/mini_bench/pic5.png`
* 今日目标：统一配置逻辑、完善评测指标模块（Toxicity API），验证 Detoxify 本地推理可用性。

---

## 2. 参数与运行配置

| 类别    | 键                    | 值                            | 说明              |
|-------|----------------------|------------------------------|-----------------|
| 精度    | precision            | bf16                         | 非量化时生效          |
| 设备映射  | device_map           | auto                         | 默认单卡自动分配        |
| 解码参数  | max_new_tokens       | 256                          | 上限固定            |
| 解码参数  | min_new_tokens       | 64                           | 暂未启用            |
| 采样    | do_sample            | true                         | LLaVA 内部被关闭     |
| 温度    | temperature          | 0.2                          | 采样关闭时不生效        |
| top-p | top_p                | 0.95                         | 采样关闭时不生效        |
| 随机种子  | seed                 | 42                           | 全局统一            |
| 量化    | quantization.enabled | true                         | 已替代旧键           |
| 量化    | compute_dtype        | bf16                         | BitsAndBytes 路径 |
| 模型路径  | LLaVA                | `/data2/.../llava-1.5-7b-hf` | 本地              |
| 模型路径  | IDEFICS2             | `HuggingFaceM4/idefics2-8b`  | 远端              |
| 评测模块  | Toxicity             | Detoxify 模型                  | 已本地部署可用         |

---

## 3. 当前进展与结果

**（1）模型部分：**

* 完成统一量化参数接口与精度键映射。
* 解决 IDEFICS2 的 `accelerate.dispatch_model` 全局冲突与默认设备污染问题。
* LLaVA 增强防幻觉系统提示；输出后处理策略稳定。

**（2）评测部分：**

* ✅ **Detoxify 模型部署成功**：
  已下载至本地，推理正常，可计算每条 response 的毒性得分。输出格式兼容指标模块，已通过单例测试。

* ⚠️ **Perspective API**：
  尚未申请 API Key，接口配置文件预留空位，等待部署后补全。

* ⚠️ **OpenAI API**：
  Key 已申请成功，但服务器无外网访问权限，当前请求均超时。考虑后续使用代理或迁移评测节点。

* ⏸️ **其他模型（如 HateBERT、RoBERTa-based 判别器）**：暂未集成。

---

## 4. 问题与风险追踪

| ID           | 描述                                        | 严重程度 | 状态      | 备注                          |
|--------------|-------------------------------------------|------|---------|-----------------------------|
| B20251112-1  | `smoke_test_models.py` 的 `GenCfg` 导入路径未修正 | 高    | 未解决     | 仍从 `src.models.idefics2` 导入 |
| B20251112-5  | `registry.py` 未使用 revision 字段             | 中    | 未解决     | 建议透传并落盘                     |
| B20251112-6  | LLaVA 未读取 runtime 中的采样参数                  | 中    | 部分解决    | 内部强制关闭采样                    |
| B20251112-8  | IDEFICS2 Processor 未开启 `local_files_only` | 中    | 未解决     | 离线环境可能出错                    |
| B20251112-9  | `device_kwargs()` 未被 wrapper 调用           | 低    | 未解决     | 可清理或在统一加载中使用                |
| B20251112-13 | OpenAI API 因服务器无法访问外网而不可用                 | 高    | **新问题** | 可通过代理或迁移主机解决                |
| B20251112-14 | Perspective API 未注册 Key                   | 中    | **新问题** | 待申请并添加到配置                   |
| B20251112-15 | 毒性评测 Detoxify 模块缺少日志化与缓存机制                | 中    | **新问题** | 建议记录模型版本与哈希，启用本地缓存          |
| B20251112-16 | 毒性评测结果尚未整合入 ASR/Toxicity 主指标统计管线          | 中    | **新问题** | 需统一输出格式与日志字段                |

---

## 5. 后续计划

1. **短期目标（1–2 日）**

   * 修正 `smoke_test_models.py` 导入路径。
   * 在 `runtime` 解析时调用 `normalize_runtime()`，确保键位一致。
   * 补充 Detoxify 模块的结果写入逻辑（`toxicity_score`, `label`, `model_version`）。
   * 添加本地 Detoxify 缓存清单 (`outputs/metrics/detoxify_cache.jsonl`)。

2. **中期目标（3–5 日）**

   * Perspective API 注册与 API 接口验证。
   * 研究通过 SSH 隧道或代理方式在服务器侧访问 OpenAI API。
   * 将 Detoxify、Perspective、OpenAI 三者封装为统一评测接口（如 `toxicity_evaluator.py`）。
   * 集成进指标计算脚本，使 `ASR`、`Toxicity` 同步输出。

3. **长期目标**

   * 扩展多源裁判机制：融合 LLM 判定与 Detoxify 结果。
   * 增加置信度聚合方法与人工复核比对逻辑。

---

## 6. 提交与同步

* Git Commit：待提交
* 日志上传：本地路径 `/outputs/logs/smoke_test.jsonl`
* 时间戳：2025-11-12 JST
